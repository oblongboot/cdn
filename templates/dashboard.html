<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
    --bg: #f7fafc;
    --text: #2d3748;
    --card-bg: #fff;
    --card-shadow: rgba(0,0,0,0.08);
    --stat-users: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --stat-files: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --table-header-bg: #f7fafc;
    --table-border: #e2e8f0;
    --empty-text: #a0aec0;
    --upload-bg: #f7fafc;
    --upload-border: #cbd5e0;
}

body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    margin: 0;
}

body.dark-mode {
    --bg: #1a202c;
    --text: #e2e8f0;
    --card-bg: #2d3748;
    --card-shadow: rgba(0,0,0,0.4);
    --table-header-bg: #2d3748;
    --table-border: #4a5568;
    --empty-text: #a0aec0;
    --upload-bg: #2d3748;
    --upload-border: #718096;
}

.navbar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px 40px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.navbar-brand {
    display: flex;
    align-items: center;
    gap: 12px;
    color: white;
    font-size: 24px;
    font-weight: 700;
}

.navbar-brand i { font-size: 28px; }

.logout-btn, .darkmode-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 10px 24px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.logout-btn:hover, .darkmode-btn:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-2px); }

.container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }

.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 40px; }

.stat-card {
    background: var(--card-bg);
    padding: 28px;
    border-radius: 16px;
    box-shadow: 0 2px 12px var(--card-shadow);
    display: flex;
    align-items: center;
    gap: 20px;
    transition: all 0.3s ease;
}

.stat-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px var(--card-shadow); }

.stat-icon {
    width: 64px; height: 64px; border-radius: 14px; display: flex;
    align-items: center; justify-content: center; font-size: 28px; color: white;
}

.stat-icon.users { background: var(--stat-users); }
.stat-icon.files { background: var(--stat-files); }

.stat-info h3 { font-size: 32px; font-weight: 700; margin-bottom: 4px; color: var(--text); }
.stat-info p { font-size: 14px; color: #718096; font-weight: 500; }

.card { background: var(--card-bg); border-radius: 16px; box-shadow: 0 2px 12px var(--card-shadow); padding: 32px; margin-bottom: 30px; }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
.card-header h2 { font-size: 22px; font-weight: 700; display: flex; align-items: center; gap: 10px; color: var(--text); }
.card-header i { color: #667eea; }
.refresh-btn { background: var(--bg); border: none; color: #667eea; padding: 10px 18px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; }
.refresh-btn:hover { background: #edf2f7; transform: rotate(180deg); }

table { width: 100%; border-collapse: separate; border-spacing: 0; }
thead { background: var(--table-header-bg); }
th { padding: 16px; text-align: left; font-weight: 600; font-size: 13px; color: #4a5568; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--table-border); }
td { padding: 18px 16px; border-bottom: 1px solid var(--table-border); color: var(--text); font-size: 14px; }
tbody tr { transition: all 0.2s ease; }
tbody tr:hover { background: #f7fafc; }
body.dark-mode tbody tr:hover { background: #2a2f3a; }

.delete-btn { background: #fed7d7; color: #c53030; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; display: inline-flex; align-items: center; gap: 6px; transition: all 0.3s ease; }
.delete-btn:hover { background: #fc8181; color: white; transform: translateY(-2px); }

.upload-area { border: 2px dashed var(--upload-border); border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; background: var(--upload-bg); transition: all 0.3s ease; }
.upload-area:hover { border-color: #667eea; background: #edf2f7; }
.upload-area.dragover { border-color: #667eea; background: #e6f2ff; }
.upload-icon { font-size: 48px; color: #cbd5e0; margin-bottom: 16px; }
.upload-area:hover .upload-icon { color: #667eea; }
.upload-text { font-size: 16px; color: #4a5568; margin-bottom: 8px; }
.upload-subtext { font-size: 14px; color: #a0aec0; }
.file-input { display: none; }
.upload-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 28px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px; margin-top: 16px; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s ease; }
.upload-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5); }
.upload-btn:disabled { background: #cbd5e0; cursor: not-allowed; transform: none; box-shadow: none; }
.result-message { margin-top: 20px; padding: 14px 18px; border-radius: 10px; font-size: 14px; font-weight: 500; display: none; align-items: center; gap: 10px; }
.result-message.show { display: flex; }
.result-message.success { background: #c6f6d5; color: #22543d; }
.result-message.error { background: #fed7d7; color: #c53030; }
.empty-state { text-align: center; padding: 60px 20px; color: var(--empty-text); }
.empty-state i { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
.empty-state p { font-size: 16px; }

@media (max-width: 768px) {
    .navbar { padding: 16px 20px; }
    .navbar-brand { font-size: 20px; }
    .container { padding: 0 16px; }
    .card { padding: 20px; }
    table { font-size: 13px; }
    th, td { padding: 12px 8px; }
}
</style>
</head>
<body>
<nav class="navbar">
    <div class="navbar-brand">
        <i class="fas fa-layer-group"></i>
        <span>Dashboard</span>
    </div>
    <div style="display: flex; gap: 12px;">
        <button class="darkmode-btn" onclick="toggleDarkMode()">
            <i class="fas fa-moon"></i> Dark Mode
        </button>
        <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>
</nav>

<div class="container">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon users"><i class="fas fa-users"></i></div>
            <div class="stat-info"><h3 id="user-count">0</h3><p>Total Users</p></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon files"><i class="fas fa-file-alt"></i></div>
            <div class="stat-info"><h3 id="file-count">0</h3><p>Files Uploaded</p></div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-users"></i> User Management</h2>
            <button class="refresh-btn" onclick="fetchUsers()"><i class="fas fa-sync-alt"></i></button>
        </div>
        <table>
            <thead>
                <tr><th>ID</th><th>Username</th><th>Created At</th><th>Action</th></tr>
            </thead>
            <tbody id="user-table">
                <tr><td colspan="4">
                    <div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading users...</p></div>
                </td></tr>
            </tbody>
        </table>
    </div>
    
    <div class="card">
        <div class="card-header"><h2><i class="fas fa-cloud-upload-alt"></i> File Upload</h2></div>
        <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
            <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
            <div class="upload-text">Click to upload or drag and drop</div>
            <div class="upload-subtext">Support for all file types</div>
            <input type="file" id="file-input" class="file-input" onchange="handleFileSelect(event)">
            <button class="upload-btn" id="upload-btn" onclick="upload(event)" style="display: none;"><i class="fas fa-upload"></i><span id="upload-btn-text">Upload File</span></button>
        </div>
        <div id="upload-result" class="result-message"></div>
    </div>
</div>

<script>
const token = localStorage.getItem("token");
if(!token) window.location.href = "/";

if(localStorage.getItem("darkMode") === "true") document.body.classList.add("dark-mode");

function toggleDarkMode() {
    document.body.classList.toggle("dark-mode");
    const btn = document.querySelector(".darkmode-btn i");
    btn.classList.toggle("fa-moon");
    btn.classList.toggle("fa-sun");
    localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
}

let selectedFile = null, fileCount = fetchFiles();
const uploadArea = document.getElementById("upload-area");
uploadArea.addEventListener("dragover", e=>{ e.preventDefault(); uploadArea.classList.add("dragover"); });
uploadArea.addEventListener("dragleave", ()=>{ uploadArea.classList.remove("dragover"); });
uploadArea.addEventListener("drop", e=>{ e.preventDefault(); uploadArea.classList.remove("dragover"); const files=e.dataTransfer.files;if(files.length>0){ document.getElementById("file-input").files=files; handleFileSelect({target:{files:files}}); } });

function handleFileSelect(event){
    selectedFile=event.target.files[0];
    if(selectedFile){
        document.querySelector(".upload-icon").innerHTML='<i class="fas fa-file-check"></i>';
        document.querySelector(".upload-text").textContent=selectedFile.name;
        document.querySelector(".upload-subtext").textContent=formatFileSize(selectedFile.size);
        document.getElementById("upload-btn").style.display="inline-flex";
    }
}

function formatFileSize(bytes){ if(bytes===0)return '0 Bytes'; const k=1024,s=['Bytes','KB','MB','GB'],i=Math.floor(Math.log(bytes)/Math.log(k)); return Math.round(bytes/Math.pow(k,i)*100)/100+' '+s[i]; }

async function fetchUsers(){
    try{
        const res=await fetch("/logins",{ headers:{"Authorization":"Bearer "+token} });
        if(!res.ok){ if(res.status===401){ localStorage.removeItem("token"); window.location.href="/"; return; } throw new Error("Failed to fetch users"); }
        const data=await res.json();
        const tbody=document.getElementById("user-table");
        tbody.innerHTML="";
        if(data.length===0){ tbody.innerHTML=`<tr><td colspan="4"><div class="empty-state"><i class="fas fa-users-slash"></i><p>No users found</p></div></td></tr>`; }
        else{ data.forEach(u=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td><strong>#${u.id}</strong></td><td>${u.username}</td><td>${new Date(u.created_at).toLocaleString()}</td><td><button class="delete-btn" onclick="deleteUser('${u.username}')"><i class="fas fa-trash-alt"></i> Delete</button></td>`; tbody.appendChild(tr); }); }
        document.getElementById("user-count").textContent=data.length;
    } catch(e){ console.error("Error fetching users:",e); }
}

async function deleteUser(username){
    if(!confirm(`Are you sure you want to delete user "${username}"?`)) return;
    try{
        const res=await fetch("/login/"+username,{ method:"DELETE", headers:{"Authorization":"Bearer "+token} });
        const data=await res.json();
        if(res.ok){ showNotification("User deleted successfully","success"); fetchUsers(); }
        else showNotification(data.error || "Failed to delete user","error");
    } catch(e){ showNotification("Error deleting user","error"); }
}

async function upload(event){
    event.stopPropagation();
    if(!selectedFile){ showUploadResult("Please select a file","error"); return; }
    const uploadBtn=document.getElementById("upload-btn");
    const uploadBtnText=document.getElementById("upload-btn-text");
    const resultDiv=document.getElementById("upload-result");
    uploadBtn.disabled=true; uploadBtnText.innerHTML='<i class="fas fa-spinner fa-spin"></i> Uploading...'; resultDiv.classList.remove("show");
    const formData=new FormData(); formData.append("file",selectedFile);
    try{
        const res=await fetch("/upload",{ method:"POST", headers:{"Authorization":"Bearer "+token}, body:formData });
        const data=await res.json();
        if(res.ok){ showUploadResult(`File uploaded successfully: ${data.filename}`,"success"); fileCount = fetchFiles(); document.getElementById("file-count").textContent=fileCount; resetUploadArea(); }
        else showUploadResult(data.error || "Upload failed","error");
    } catch(e){ showUploadResult("Error uploading file","error"); }
    finally{ uploadBtn.disabled=false; uploadBtnText.innerHTML='<i class="fas fa-upload"></i> Upload File'; }
}

function showUploadResult(message,type){
    const resultDiv=document.getElementById("upload-result");
    resultDiv.className=`result-message show ${type}`;
    resultDiv.innerHTML=`<i class="fas fa-${type==='success'?'check-circle':'exclamation-circle'}"></i> ${message}`;
}

function resetUploadArea(){
    selectedFile=null;
    document.getElementById("file-input").value="";
    document.querySelector(".upload-icon").innerHTML='<i class="fas fa-cloud-upload-alt"></i>';
    document.querySelector(".upload-text").textContent="Click to upload or drag and drop";
    document.querySelector(".upload-subtext").textContent="Support for all file types";
    document.getElementById("upload-btn").style.display="none";
}

function showNotification(message,type){
    const notification=document.createElement("div");
    notification.style.cssText=`position:fixed;top:20px;right:20px;background:${type==='success'?'#c6f6d5':'#fed7d7'};color:${type==='success'?'#22543d':'#c53030'};padding:16px 24px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.15);z-index:1000;display:flex;align-items:center;gap:12px;font-weight:600;animation:slideInRight 0.3s ease;`;
    notification.innerHTML=`<i class="fas fa-${type==='success'?'check-circle':'exclamation-circle'}"></i>${message}`;
    document.body.appendChild(notification);
    setTimeout(()=>{ notification.style.animation="slideOutRight 0.3s ease"; setTimeout(()=>notification.remove(),300); },3000);
}

async function fetchFiles() {
    try {
        const res = await fetch("/files", {
            headers: { "Authorization": "Bearer " + token }
        });
        const files = await res.json();
        document.getElementById("file-count").textContent = files.length;
        renderFileList(files);
    } catch (err) {
        console.error(err);
    }
}


function logout(){ localStorage.removeItem("token"); window.location.href="/"; }
fetchUsers();
</script>
</body>
</html>
